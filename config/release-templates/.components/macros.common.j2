{# TODO: move to configuration for user to modify #}
{% set section_heading_translations = {
    'feat': 'features',
    'fix': 'bug fixes',
    'perf': 'performance improvements',
    'docs': 'documentation',
    'build': 'build system',
    'refactor': 'refactoring',
    'test': 'testing',
    'ci': 'continuous integration',
    'chore': 'chores',
    'style': 'code style',
  }
%}

{% set section_heading_order = section_heading_translations.values() %}

{% set emoji_map = {
    'breaking': 'ðŸ’¥',
    'features': 'âœ¨',
    'bug fixes': 'ðŸª²',
    'performance improvements': 'âš¡',
    'documentation': 'ðŸ“–',
    'build system': 'âš™ï¸',
    'refactoring': 'â™»ï¸',
    'testing': 'âœ…',
    'continuous integration': 'ðŸ¤–',
    'chores': 'ðŸ§¹',
    'code style': 'ðŸŽ¨',
    'unknown': 'â—',
    'release_note': 'ðŸ’¡',
} %}


{#
  MACRO: Capitalize the first letter of a string only
#}{%  macro capitalize_first_letter_only(sentence)
%}{{    (sentence[0] | upper) ~ sentence[1:]
}}{%  endmacro
%}


{#
  MACRO: format a commit descriptions list by:
  - Capitalizing the first line of the description
  - Adding an optional scope prefix
  - Joining the rest of the descriptions with a double newline
#}{%  macro format_attr_paragraphs(commit, attribute)
%}{#    NOTE: requires namespace because of the way Jinja2 handles variable scoping with loops
#}{%    set ns = namespace(full_description="")
%}{#
#}{%    if commit.error is undefined
%}{%      for paragraph in commit | attr(attribute)
%}{%        if paragraph | trim | length > 0
%}{#
#}{%          set ns.full_description = [
                ns.full_description,
                capitalize_first_letter_only(paragraph) | trim | safe,
              ] | join("\n\n")
%}{#
#}{%        endif
%}{%      endfor
%}{#
#}{%      set ns.full_description = ns.full_description | trim
%}{#
#}{%      if commit.scope
%}{%        set ns.full_description = "**%s**: %s" | format(
              commit.scope, ns.full_description
            )
%}{%      endif
%}{%    endif
%}{#
#}{{    ns.full_description
}}{%  endmacro
%}


{#
   MACRO: order commits alphabetically by scope and attribute
   - Commits are sorted based on scope and then the attribute alphabetically
   - Commits without scope are placed first and sorted alphabetically by the attribute
   - parameter: ns (namespace) object with a commits list
   - parameter: attr (string) attribute to sort by
   - returns None but modifies the ns.commits list in place
#}{%  macro order_commits_alphabetically_by_scope_and_attr(ns, attr)
%}{%    set ordered_commits = []
%}{#
   #    # Eliminate any ParseError commits from input set
#}{%    set filtered_commits = ns.commits | rejectattr("error", "defined") | list
%}{#
   #    # grab all commits with no scope and sort alphabetically by attr
#}{%    for commit in filtered_commits | rejectattr("scope") | sort(attribute=attr)
%}{%      set _ = ordered_commits.append(commit)
%}{%     endfor
%}{#
   #    # grab all commits with a scope and sort alphabetically by the scope and then attr
#}{%    for commit in filtered_commits | selectattr("scope") | sort(attribute=(['scope', attr] | join(",")))
%}{%      set _ = ordered_commits.append(commit)
%}{%    endfor
%}{#
   #    # Return the ordered commits
#}{%    set ns.commits = ordered_commits
%}{%  endmacro
%}


{#
  MACRO: apply smart ordering of commits objects based on alphabetized summaries and then scopes
  - Commits are sorted based on the commit type and the commit message
  - Commits are grouped by the commit type
  - parameter: ns (namespace) object with a commits list
  - returns None but modifies the ns.commits list in place
#}{%  macro apply_alphabetical_ordering_by_descriptions(ns)
%}{%    set _ = order_commits_alphabetically_by_scope_and_attr(ns, 'descriptions.0')
%}{%  endmacro
%}


{#
  MACRO: render a special section (breaking changes or release notices)
  - Extracts commits with the specified attribute
  - Orders them alphabetically by scope and attribute
  - Formats and renders the section with header and descriptions
  - parameter: commit_objects - the list of commit tuples
  - parameter: filter_attr - attribute to filter commits by (e.g., 'breaking_descriptions.0')
  - parameter: sort_attr - attribute to sort by (e.g., 'breaking_descriptions.0')
  - parameter: format_attr - attribute name for format_attr_paragraphs (e.g., 'breaking_descriptions')
  - parameter: section_title - the section header text (e.g., 'Breaking Changes')
  - parameter: emoji_key - key for emoji_map (e.g., 'breaking')
  - parameter: max_line_width - maximum line width for text wrapping
  - parameter: hanging_indent - indent for wrapped lines
#}{%  macro render_special_section(commit_objects, filter_attr, sort_attr, format_attr, section_title, emoji_key, max_line_width, hanging_indent)
%}{#    Extract and flatten commits with the specified attribute
#}{%    set filtered_commits = commit_objects | map(attribute="1") | sum(start=[])
%}{%    set filtered_commits = filtered_commits | rejectattr("error", "defined") | selectattr(filter_attr) | list
%}{#
#}{%    if filtered_commits | length > 0
%}{#      Order commits alphabetically
#}{%      set ns = namespace(commits=filtered_commits)
%}{%      set _ = order_commits_alphabetically_by_scope_and_attr(ns, sort_attr)
%}{#
#}{%      set descriptions = []
%}{#
#}{%      for commit in ns.commits
%}{%        set full_description = "- %s" | format(
              format_attr_paragraphs(commit, format_attr).split("\n\n") | join("\n\n- ")
            )
%}{%        set _ = descriptions.append(
              full_description | autofit_text_width(max_line_width, hanging_indent)
            )
%}{%      endfor
%}{#
   #      Render section header and descriptions
#}{{      "\n"
}}{{      "### %s %s\n" | format(emoji_map[emoji_key], section_title)
}}{{
          "\n%s\n" | format(descriptions | unique | join("\n\n"))
}}{%    endif
%}{%  endmacro
%}
