---
name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review, reopened]

jobs:
  claude-review:
    name: Claude Code Review
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write

    steps:
      - name: Setup | Checkout repository
        uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6
        with:
          fetch-depth: 1

      - name: Review | Run Claude Code Review
        id: claude-review
        uses: anthropics/claude-code-action@ea36d6abdedc17fc2a671b36060770b208a6f8f1 # v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          use_sticky_comment: true
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            You are reviewing a Python 3.11+ framework using hexagonal architecture, Dishka IoC, and strict typing with Protocols and ABCs.
            The PR branch is already checked out. Read the CLAUDE.md file at the repo root for project conventions.

            ## Review scope

            Focus exclusively on issues introduced by this PR. Ignore pre-existing code problems.
            Skip anything that linters or type checkers will catch (ruff and mypy run in CI).

            Review for:
            1. **Bugs and logic errors** — incorrect behavior, missing edge cases, race conditions
            2. **Security vulnerabilities** — injection, data exposure, unsafe deserialization, improper input validation
            3. **CLAUDE.md compliance** — verify changes follow the project conventions defined in CLAUDE.md
            4. **Architectural violations** — broken layer boundaries, wrong dependency direction, leaking infrastructure into domain
            5. **Performance** — unnecessary allocations, N+1 patterns, missing async where needed

            Do NOT flag: style preferences, minor naming suggestions, missing docstrings, or general quality nits.

            ## Output format

            For each issue, explain *why* it matters and suggest a concrete fix.
            Use `mcp__github_inline_comment__create_inline_comment` for specific code issues with line references.
            Use `gh pr comment` for a single top-level summary.

            If no issues are found, post a short approval comment.
            Only post GitHub comments — do not submit review text as messages.
          claude_args: |
            --allowedTools "mcp__github_inline_comment__create_inline_comment,Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*)"
